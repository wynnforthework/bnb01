# 合约交易功能使用指南

## 🎯 功能概述

系统现已支持完整的合约交易功能，包括现货和合约双模式交易。用户可以通过Web界面轻松切换交易模式，进行杠杆交易、做多做空等操作。

## 🚀 快速开始

### 1. 启动系统

```bash
# 启动Web服务器
python app.py
```

### 2. 访问Web界面

打开浏览器访问: `http://localhost:5000`

### 3. 选择交易模式

在控制面板中选择交易模式：
- **现货交易**: 传统的买入持有模式
- **合约交易**: 支持杠杆、做多做空

## 📊 合约交易功能

### 交易模式切换

1. **选择合约模式**
   - 在控制面板选择"合约交易"
   - 设置杠杆倍数（5x-100x）
   - 点击"切换模式"按钮

2. **系统自动配置**
   - 设置双向持仓模式
   - 配置逐仓保证金
   - 初始化合约策略

### 手动下单功能

1. **点击"手动下单"按钮**
2. **配置订单参数**：
   - 交易对：选择要交易的币种
   - 交易方向：买入/卖出（做多/做空）
   - 持仓方向：LONG/SHORT
   - 杠杆倍数：5x-100x
   - 订单类型：市价单/限价单
   - 交易数量：输入交易数量

3. **查看订单预览**：
   - 预计成本
   - 所需保证金
   - 当前价格/标记价格
   - 资金费率

4. **提交订单**

### 持仓管理

1. **查看持仓**：
   - 交易对和方向
   - 持仓数量
   - 入场价格/标记价格
   - 未实现盈亏
   - 保证金和杠杆

2. **一键平仓**：
   - 点击持仓旁的"平仓"按钮
   - 确认平仓操作

### 策略交易

1. **启动合约策略**：
   - 点击"启动交易"
   - 系统自动执行合约策略
   - 支持做多做空双向交易

2. **策略特性**：
   - 自动杠杆设置
   - 动态止损止盈
   - 风险管理集成

## 🔧 高级功能

### 杠杆和保证金设置

```python
# 通过API设置杠杆
POST /api/futures/leverage/set
{
    "symbol": "BTCUSDT",
    "leverage": 10
}

# 设置保证金模式
POST /api/futures/margin/set
{
    "symbol": "BTCUSDT",
    "margin_type": "ISOLATED"  # 或 "CROSSED"
}
```

### 程序化交易

```python
# 创建合约交易引擎
from backend.trading_engine import TradingEngine

# 初始化合约交易引擎
futures_engine = TradingEngine(
    trading_mode='FUTURES',
    leverage=10
)

# 启动交易
futures_engine.start_trading()
```

## 📈 API端点

### 合约账户管理
- `GET /api/futures/account` - 获取合约账户信息
- `GET /api/futures/positions` - 获取合约持仓
- `POST /api/futures/position/close` - 平仓

### 合约交易
- `POST /api/futures/order/place` - 下合约订单
- `POST /api/futures/trading/start` - 启动合约交易
- `POST /api/futures/trading/stop` - 停止合约交易
- `GET /api/futures/trading/status` - 获取交易状态

### 合约设置
- `POST /api/futures/leverage/set` - 设置杠杆
- `POST /api/futures/margin/set` - 设置保证金模式
- `GET /api/futures/market/{symbol}` - 获取合约市场数据

### 交易模式
- `GET /api/trading/mode` - 获取交易模式状态
- `POST /api/trading/switch` - 切换交易模式

## 🛡️ 风险管理

### 自动风险控制
- **杠杆限制**: 最高100x杠杆
- **保证金监控**: 实时保证金率监控
- **自动止损**: 基于ATR的动态止损
- **强制平仓**: 保证金不足时自动平仓

### 风险参数
```python
# 合约风险参数（可在risk_manager.py中调整）
max_leverage = 100          # 最大杠杆
margin_ratio_warning = 0.8  # 保证金率警告线
margin_ratio_liquidation = 0.9  # 强制平仓线
max_position_size = 0.3     # 单个资产最大权重
```

## 📊 界面功能

### 控制面板
- 交易模式选择（现货/合约）
- 杠杆倍数设置
- 交易控制按钮
- 实时状态显示

### 持仓显示
- 现货持仓表格
- 合约持仓表格（支持做多做空）
- 实时盈亏计算
- 一键平仓功能

### 手动下单
- 直观的订单界面
- 实时市场信息
- 订单预览功能
- 合约特有参数设置

## 🔍 监控和分析

### 实时数据
- 当前价格/标记价格
- 资金费率
- 持仓盈亏
- 保证金使用率

### 历史分析
- 交易历史记录
- 策略表现分析
- 风险指标统计
- 盈亏曲线图

## ⚠️ 注意事项

### 风险提示
1. **杠杆风险**: 高杠杆可能导致快速亏损
2. **资金费率**: 持仓过夜需支付资金费用
3. **强制平仓**: 保证金不足时会被强制平仓
4. **市场风险**: 加密货币市场波动较大

### 建议设置
1. **新手用户**: 建议使用5x-10x杠杆
2. **风险控制**: 设置合理的止损止盈
3. **资金管理**: 不要使用全部资金开仓
4. **策略测试**: 先在测试网络验证策略

## 🆘 故障排除

### 常见问题

1. **无法切换到合约模式**
   - 检查API密钥是否支持合约交易
   - 确认账户已开通合约权限

2. **下单失败**
   - 检查保证金是否充足
   - 确认交易对是否支持合约交易
   - 验证数量精度是否正确

3. **持仓显示异常**
   - 刷新页面重新加载数据
   - 检查网络连接状态

### 技术支持

如遇到技术问题，请：
1. 查看浏览器控制台错误信息
2. 检查服务器日志
3. 确认API连接状态
4. 验证配置文件设置

## 🎉 总结

合约交易功能已完全集成到系统中，提供了：

✅ **完整的合约交易支持**
✅ **直观的Web界面操作**
✅ **自动化策略交易**
✅ **实时风险管理**
✅ **灵活的参数配置**

现在您可以通过Web界面轻松进行合约交易，享受杠杆交易带来的更多机会！